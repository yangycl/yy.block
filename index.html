<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>Blockly Demo</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly/msg/zh-hant.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #blocklyDiv { height: 500px; width: 100%; }
  </style>
</head>
<body>
  

  <div id="blocklyDiv"></div>
  <xml id="toolbox" style="display: none">
    <category name="控制" colour="210">
    <block type="repeat_times_simple"></block>
     <block type="break_loop"></block>
    <block type="continue_loop"></block>
    <block type="alert_loop"></block>
  </category>
  
  </xml>
  <iframe id="sandboxFrame" sandbox="allow-scripts" style="width:0; height:0; border:0;"></iframe>
  <button onclick="runcode()">執行</button>
  <script>
    function runCode() {
      var code = Blockly.JavaScript.workspaceToCode(Blockly.getMainWorkspace());
      var iframe = document.getElementById('sandboxFrame');
    
      var html = `
        <!DOCTYPE html>
        <html>
        <head><meta charset="UTF-8"></head>
        <body>
          <script>
            try {
              ${code}
            } catch (e) {
              alert("執行時發生錯誤: " + e.message);
            }
          <\/script>
        </body>
        </html>
      `;
    
      // 把 code 放進 iframe 中執行
      var blob = new Blob([html], { type: 'text/html' });
      var url = URL.createObjectURL(blob);
      iframe.src = url;
    }
        Blockly.Blocks['repeat_times_simple'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("重複次數")
          .appendField(new Blockly.FieldNumber(10, 1, 100), "TIMES");
        this.appendStatementInput("DO")
          .setCheck(null)
          .appendField("執行");
        this.setColour(120);
        this.setTooltip("重複指定次數執行一段程式碼");
        this.setHelpUrl("");
      }
    };
    Blockly.JavaScript['repeat_times_simple'] = function(block) {
  var times = block.getFieldValue('TIMES');
  var statements_do = Blockly.JavaScript.statementToCode(block, 'DO');
  var code = `for (var i = 0; i < ${times}; i++) {\n` +
             statements_do + 
             `}\n`;
  return code;
};
Blockly.Blocks['break_loop'] = {
      init: function () {
        this.appendDummyInput().appendField("跳出迴圈");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(210);
        this.setTooltip("離開迴圈");
      }
    };

    Blockly.JavaScript['break_loop'] = function(block) {
      return 'break;\n';
    };

    Blockly.Blocks['continue_loop'] = {
    init: function () {
        this.appendDummyInput()
        .appendField("繼續下一次迴圈");
        this.setPreviousStatement(true, null);  // 可以接前一個積木
        this.setNextStatement(true, null);      // 可以接下一個積木
        this.setColour(210);                     // 綠色
        this.setTooltip("跳過當前迴圈，繼續下一次");
    }
    };
    Blockly.JavaScript['continue_loop'] = function(block) {
        return 'continue;\n';
    };
    // 定义其他积木类型彈出視窗
    // 定義 alert_loop 積木
Blockly.Blocks["alert_loop"] = {
    init: function () {
       this.appendDummyInput()
      .appendField("彈出訊息")
      .appendField(new Blockly.FieldTextInput("你好"), "TEXT");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(210);
    this.setTooltip("彈出一段文字訊息");
  }
};

// 定義 JavaScript 產生器
Blockly.JavaScript["alert_loop"] = function (block) {
  const msg = block.getFieldValue("TEXT");
  return `alert("${msg}");\n`;
};

   // 初始化 Blockly

    Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox')
    });
  </script>
</body>
</html>
