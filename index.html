<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>Blockly Demo</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly/msg/zh-hant.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #blocklyDiv { height: 500px; width: 100%; }
  </style>
</head>
<body>
  

  <div id="blocklyDiv"></div>
  <xml id="toolbox" style="display: none">
    <category name="控制" colour="210">
    <block type="repeat_times_simple"></block>
     <block type="break_loop"></block>
    <block type="continue_loop"></block>
    <block type="alert_loop"></block>
    <block type="if"></block>
  </category>
  
    <category name="變數" colour="330" custom="VARIABLE">
      <block type="var_set"></block>
      
    </category>
    <category name="邏輯" colour="210">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_boolean"></block>
      <block type="logic_null"></block>
      <block type="logic_ternary"></block>
    </category>
    <category name="數字與運算" colour="230">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
    </category>


  </xml>
  <iframe id="sandboxFrame" sandbox="allow-scripts"
    srcdoc="
      <!DOCTYPE html>
      <html>
      <body>
        <script>
          window.addEventListener('message', function(e) {
            try {
              eval(e.data);
            } catch (err) {
              alert('錯誤：' + err.message);
            }
          });
        <\/script>
      </body>
      </html>
    ">
  </iframe>

  <button onclick="runCode()">執行</button>
  <script>
    function runCode() {
      const code = Blockly.JavaScript.workspaceToCode(Blockly.getMainWorkspace());
      const iframe = document.getElementById('sandboxFrame');
      iframe.contentWindow.postMessage(code, '*');
    }
    // 定义 repeat_times_simple 积木
        Blockly.Blocks['repeat_times_simple'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("重複次數")
          .appendField(new Blockly.FieldNumber(10, 1, 100), "TIMES");
        this.appendStatementInput("DO")
          .setCheck(null)
          .appendField("執行");
        this.setColour(120);
        this.setTooltip("重複指定次數執行一段程式碼");
        this.setHelpUrl("");
      }
    };
    Blockly.JavaScript['repeat_times_simple'] = function(block) {
      var times = block.getFieldValue('TIMES');
      var statements_do = Blockly.JavaScript.statementToCode(block, 'DO');
      var code = `for (var i = 0; i < ${times}; i++) {\n` +
                statements_do + 
                `}\n`;
      return code;
    };
    Blockly.Blocks['break_loop'] = {
      init: function () {
        this.appendDummyInput().appendField("跳出迴圈");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(210);
        this.setTooltip("離開迴圈");
      }
    };

    Blockly.JavaScript['break_loop'] = function(block) {
      return 'break;\n';
    };

    Blockly.Blocks['continue_loop'] = {
    init: function () {
        this.appendDummyInput()
        .appendField("繼續下一次迴圈");
        this.setPreviousStatement(true, null);  // 可以接前一個積木
        this.setNextStatement(true, null);      // 可以接下一個積木
        this.setColour(210);                     // 綠色
        this.setTooltip("跳過當前迴圈，繼續下一次");
    }
    };
    Blockly.JavaScript['continue_loop'] = function(block) {
        return 'continue;\n';
    };
    // 定义其他积木类型彈出視窗
    // 定義 alert_loop 積木
    Blockly.Blocks["alert_loop"] = {
        init: function () {
          this.appendDummyInput()
          .appendField("彈出訊息")
          .appendField(new Blockly.FieldTextInput("你好"), "TEXT");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(210);
        this.setTooltip("彈出一段文字訊息");
      }
    };

    // 定義 JavaScript 產生器
    Blockly.JavaScript["alert_loop"] = function (block) {
      const msg = block.getFieldValue("TEXT");
      return `alert("${msg}");\n`;
    };
    Blockly.Blocks["var_set"] = {
      init: function () {
        this.appendDummyInput()
          .appendField("設定變數")
          .appendField(new Blockly.FieldTextInput("item"), "VAR");
        this.appendValueInput("VALUE")
          .setCheck(null)
          .appendField("為");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(330);
        this.setTooltip("設定變數的值");
        this.setHelpUrl("");
      }
    };
    Blockly.JavaScript["var_set"] = function (block) {
      var varName = block.getFieldValue("VAR");
      var valueCode = Blockly.JavaScript.valueToCode(block, "VALUE", Blockly.JavaScript.ORDER_ATOMIC);
      var code = `var ${varName} = ${valueCode};\n`;
      return code;
    };


    Blockly.Blocks["if"] = {
      init: function () {
        this.appendValueInput("IF")
          .setCheck("Boolean")
          .appendField("如果");
        this.appendStatementInput("DO")
          .setCheck(null)
          .appendField("則執行");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(210);
        this.setTooltip("如果條件為真，則執行一段程式碼");
        this.setHelpUrl("");
      }

    };
    Blockly.JavaScript["if"] = function (block) {
      var condition = Blockly.JavaScript.valueToCode(block, "IF", Blockly.JavaScript.ORDER_ATOMIC);
      var statements_do = Blockly.JavaScript.statementToCode(block, "DO");
      var code = `if (${condition}) {\n` +
                 statements_do + 
                 `}\n`;
      return code;
    };
   // 初始化 Blockly

    Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox')
    });

  </script>
</body>
</html>
